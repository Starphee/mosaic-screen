<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Dorian's Mosaic Controller</title>
  <script src="/jquery/jquery.min.js"></script>
  <script src="/axios/axios.min.js"></script>
  <script src="/iro/iro.min.js"></script>
  <link rel="stylesheet" href="/bulma/bulma.min.css">
  <link rel="stylesheet" href="interface.css">
</head>
<body>
<section class="hero is-dark is-bold">
  <div class="hero-body">
    <div class="container">
      <button id="stop" class="is-pulled-right"></button>
      <button id="rotate" class="is-pulled-right"></button>
      <h1 class="title">Dorian's Mosaic</h1>
      <div>
        <label for="brightness">Brightness:</label>
        <input type="range" id="brightness" min="1" max="254" value="100">
      </div>
    </div>
  </div>
</section>

<div class="box is-dark">
  <label class="label">
    <span>Schedule:</span>
  </label>
  <div class="field" id="schedule">
    <table class="table is-dark">
      <thead>
        <tr>
          <th>Time</th>
          <th>Mode</th>
          <th>Brightness</th>
          <th>Options</th>
          <th>Op</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td><input type="time" step="60"></input></td>
          <td colspan="3">Current State</td>
          <td><button class="button is-success">+</button></td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<div class="box">
  <label class="label">
    <span>Animations:</span>
  </label>
  <div class="field" id="images">
    Images...
  </div>
</div>


<div class="box">
  <label class="label">
    <span>Bouncy Ball:</span>
  </label>
  <div class="field" id="balls">
    <div class="picker"></div>
  </div>
</div>

<div class="box">
  <label class="label">
    <span>Clock:</span>
  </label>
  <div class="field" id="clock">
    <div class="picker"></div>
  </div>
</div>


<div class="box">
  <label class="label">
    <span>Scrolling Text:</span>
  </label>
  <div class="field" id="text">
    <label for="speed">Speed:</label>
    <input type="range" id="speed" min="1" max="5" value="2">
    <input type="text" id="text-input" value="Sample text">
    <div class="picker"></div>
  </div>
</div>

<div class="box">
  <label class="label">
    <span>Solid Color:</span>
  </label>
  <div class="field" id="solid">
    <div class="picker"></div>
  </div>
</div>

<div class="box">
  <label class="label">
    <span>Power:</span>
  </label>
  <div class="field" id="power">
  </div>
</div>

<script type="text/javascript">
  function post(name, opts = true) {
    const data = {};
    data[name] = opts;
    return axios.post('data', data);
  }

  // Bind buttons.
  $('#stop').click(() => {
    post('stop');
  });

  $('#rotate').click(() => {
    post('rotate', 5);
  });

  // Bind solid color change.
  const solidColor = new iro.ColorPicker('#solid .picker');
  solidColor.on('color:change', function (color) {
    post('color', color.hexString);
  });

  // Bind clock color change.
  const clockColor = new iro.ColorPicker('#clock .picker');
  clockColor.on('color:change', function (color) {
    post('clock', { color: color.hexString });
  });

  // Bind bouncy ball.
  const ballColor = new iro.ColorPicker('#balls .picker');
  ballColor.on('color:change', function (color) {
    post('ball', color.hexString);
  });

  // Bind scrolling text mode.
  const textColor = new iro.ColorPicker('#text .picker');
  textColor.on('color:change', function (color) {
    post('scroll', {
      text: $('#text-input').val(),
      size: 8,
      speed: $('#speed').val(),
      font: 'Minecraftia',
      baseline: 6,
      color: color.hexString,
    });
  });

  // Bind Brightness Slider.
  $('#brightness').change(() => {
    axios.post('bright', {brightness: $('#brightness').val()});
  });

  // Add power options
  ['shutdown', 'restart'].forEach((option) => {
    $('#power').append(
      $('<button>')
        .text(option)
        .click(() => {
          post('power', option);
        })
    );
  });

  function toAMPM(time) {
    const t = time.split(':');
    let h = parseInt(t[0], 10);
    let m = t[1];
    let mer = 'A';

    if (h > 12) {
      h = h - 12;
      mer = 'P'
    }

    return `${h}:${m} ${mer}M`;
  }

  // Get schedule options.
  function buildSchedule({ data: schedule }) {
    $('#schedule tbody').empty();
    Object.entries(schedule).forEach(([time, entry]) => {
      $('#schedule tbody').append(
        $('<tr>').append(
          $('<td>').text(toAMPM(time)),
          $('<td>').text(entry.mode),
          $('<td>').text(entry.brightness),
          $('<td>').text(JSON.stringify(entry.options)),
          $('<td>').append(
            $('<button>')
              .addClass('button is-secondary is-small')
              .text('👁️')
              .click(() => {
                axios.put(`schedule/${time}`);
              }),
            $('<button>')
              .addClass('button is-primary is-small')
              .text('🔄')
              .click(() => {
                axios.post(`schedule`, { time }).then(buildSchedule);
              }),
            $('<button>')
              .addClass('button is-danger is-small')
              .text('🗑️')
              .click(() => {
                axios.delete(`schedule/${time}`).then(buildSchedule);
              })
          )
        )
      );
    });
  }

  // Get initial schedule, bind buttons.
  axios.get('schedule').then(buildSchedule);
  $('#schedule tfoot button').click(() => {
    axios.post(`schedule`, {
      time: $('#schedule tfoot input').val(),
    }).then(buildSchedule);
  });

  

  // Get the images.
  axios.get('data').then(({ data }) => {
    $('#images').empty();
    Object.entries(data.images).forEach(([name, { fps }]) => {
      $('#images').append(
        $('<button>')
          .attr('style', `background-image: url("/images/animations/${name}_${fps}.gif")`)
          .text(name)
          .click(() => {post('image', name)})
      );
    });

    // Add plasma mode! Not really an image, but whatever...
    $('#images').append(
      $('<button>')
        .attr('id', 'plasma')
        .click(() => {post('plasma', {})})
        .text('Plasma!'),
      $('<button>')
        .attr('style', `background-image: url("/images/plasma.gif")`)
        .click(() => {post('plasma', {withClock: true})})
        .text("PClock"),
      $('<button>')
        .attr('style', `background-image: url("/images/plasma.gif")`)
        .click(() => {post('plasma', {withClock: true, flipClock: true})})
        .text("!PClock")
    );

  });
</script>
</body>
</html>
